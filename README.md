# TopNews - Telegram News Aggregation Bot

TopNews - асинхронный Telegram-бот для агрегации новостей из RSS/HTML/Telegram источников, с дедупликацией, фильтрацией, сохранением истории и AI-опциями.

## 1) Что делает бот

- Собирает новости из множества источников (RSS + HTML + Telegram каналы).
- Очищает текст, нормализует контент, определяет категорию.
- Дедуплицирует по URL/заголовку, сохраняет историю в SQLite.
- Публикует в Telegram-канал и/или отправляет в личку пользователю.
- Поддерживает фильтры по категориям и персонификацию настроек.
- Имеет prod/sandbox режимы с разной политикой доступа.

## 2) Основные процессы (end-to-end)

1. Планировщик запускает тик сбора (каждые `CHECK_INTERVAL_SECONDS`).
2. Проверяется глобальный стоп (sandbox-only). Если включен - тик пропускается.
3. Источники читаются асинхронно, с ограничением параллелизма.
4. Текст очищается, выделяются заголовок/лид/контент.
5. Классификация категории и метаданных (в т.ч. дат публикации).
6. Дедупликация (URL/hash/title).
7. Формирование поста (категория, хештеги, кнопки).
8. Публикация в канал/личку, запись результата в БД.

## 3) Архитектура (компоненты)

- `bot.py`
  - Telegram handlers (commands, callbacks, inline кнопки)
  - Периодический сбор и публикация
  - Управление настройками и доступом
- `sources/`
  - Коллектор источников и парсеры
- `utils/`
  - Очистка текста, фильтры, форматирование
- `db/database.py`
  - SQLite-хранилище новостей, статуса источников и пользовательских настроек
- `core/services/access_control.py`
  - Управление AI-уровнями (global/user)
- `core/services/collection_stop.py`
  - Redis-флаг глобальной остановки сбора (sandbox-only)
- `utils/mgmt_api.py`
  - Управляющий HTTP API для глобального стопа (sandbox-only)

## 4) Prod vs Sandbox (изоляция и доступ)

- `APP_ENV=prod` - основной бот, пользовательский доступ по инвайтам.
- `APP_ENV=sandbox` - админ-бот, доступ только админам.
- Данные и кэш разнесены по окружению (DB/Cache paths).
- Сбор новостей общий по логике, но управление доступом и настройками отличается.

### Политика доступа

- Sandbox: доступ только админам.
- Prod: доступ по инвайтам и утверждению.

## 5) Глобальная остановка сбора (sandbox-only)

- Флаг хранится в Redis: `jur:stop:global:sandbox` (значение `1`).
- TTL по умолчанию: 3600 сек. После истечения флаг снимается автоматически.
- В prod флаг игнорируется полностью: сбор никогда не останавливается из-за него.
- Переменная `GLOBAL_COLLECTION_STOP_FILE` устарела и игнорируется.

### Поведение

- В начале каждого тика сбора вызывается `get_global_collection_stop()`.
- Если включено - тик пропускается, лог: "Global collection stop is ON (sandbox). Skip tick."
- Никаких ошибок, только пропуск.

## 6) Mgmt API (sandbox-only)

HTTP API доступен только в sandbox, в prod возвращает 404:

- `GET /mgmt/collection/stop`
  - Ответ: `{ enabled: boolean, ttl_sec_remaining?: number|null }`
- `POST /mgmt/collection/stop`
  - Тело: `{ enabled: boolean, ttl_sec?: number, reason?: string, by?: string }`
  - Ответ: `{ enabled: boolean, ttl_sec_remaining?: number|null }`

API запускается на `MGMT_BIND:MGMT_PORT` (по умолчанию `0.0.0.0:8081`).

## 7) Telegram UI (кнопки/команды)

- Кнопка "Остановить/Возобновить сбор" показывается только в sandbox.
- В prod кнопки нет, и callback блокируется.
- Команды:
  - `/sync` - ручной запуск сбора
  - `/status` - статус бота
  - `/pause` / `/resume` - пауза/возобновление доставки пользователю

## 8) Хештеги и иерархия

Хештеги строятся на таксономии:
- `g0` (страна: #Россия/#Мир)
- `g1` (федеральный округ)
- `g2` (регион)
- `g3` (город)
- `r0` (рубрика)

Дубликаты в иерархии (например `#Москва` дважды) не добавляются.

## 9) AI budget guard и деградация

- Включен дневной бюджет AI (USD или token fallback).
- При превышении бюджета отключаются: `summary`, затем `cleanup`, затем `hashtags_ai`.
- Есть per-tick лимит на AI вызовы, чтобы избежать всплесков.
- Метрики видны в `/status` (calls/tokens/cost, cache hit rate, budget state).

## 10) База данных

SQLite хранит:
- опубликованные новости
- состояние источников и здоровье
- пользовательские настройки
- выборки новостей
- кеш AI

### Важное

- Prod и sandbox используют разные БД.
- Access DB может быть общим (инвайты/глобальные настройки).

## 11) Переменные окружения (ключевые)

Обязательные:
- `APP_ENV=prod|sandbox`
- `BOT_TOKEN_PROD`
- `BOT_TOKEN_SANDBOX`
- `TELEGRAM_CHANNEL_ID`

Для global stop (sandbox):
- `REDIS_URL=redis://...`

Mgmt API:
- `MGMT_BIND=0.0.0.0`
- `MGMT_PORT=8081`

Дополнительно:
- `CHECK_INTERVAL_SECONDS`
- `LOG_LEVEL`
- `DATABASE_PATH`
- `ACCESS_DB_PATH`

## 12) Запуск

Локально:
```bash
python main.py
```

Railway:
- `APP_ENV=prod` для основного сервиса
- `APP_ENV=sandbox` для админ-сервиса

## 13) Отладка

- Логи: `logs/`
- Проверка статуса: `/status`
- Принудительный сбор: `/sync`

## 14) Структура проекта (сокращенно)

```
TopNews/
  bot.py
  main.py
  main_railway.py
  config/
  core/services/
  db/
  sources/
  utils/
  tests/
```

## 15) Известные ограничения

- Без Redis флаг stop не работает (no-op).
- В prod глобальный стоп отключен логически.

## 16) Лицензия

MIT
