"""
–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–Ω—ã–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
"""
import sys
sys.path.insert(0, '.')

from config.config import AI_CATEGORY_VERIFICATION_ENABLED, AI_CATEGORY_VERIFICATION_RATE
from net.deepseek_client import DeepSeekClient
from net.llm_cache import LLMCacheManager, BudgetGuard
from db.database import NewsDatabase
import asyncio

async def test_quality_reserves():
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–µ—Ä–≤—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å"""
    
    print("=" * 60)
    print("ANALIZ RESERVOV KACHESTVA I OPTIMIZACII")
    print("=" * 60)
    
    # 1. Proverk–∞–µ–º kakie funkcii vklyucheny
    print("\n1. STATUS FUNKCIJ KACHESTVA:")
    print(f"   [OK] AI_CATEGORY_VERIFICATION_ENABLED: {AI_CATEGORY_VERIFICATION_ENABLED}")
    print(f"   [%] AI_CATEGORY_VERIFICATION_RATE: {AI_CATEGORY_VERIFICATION_RATE * 100}%")
    print(f"   ‚ÑπÔ∏è  –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç {AI_CATEGORY_VERIFICATION_RATE * 100}% –Ω–æ–≤–æ—Å—Ç–µ–π –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –ò–ò")
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –≤ DeepSeekClient
    db = NewsDatabase(db_path='db/news.db')
    client = DeepSeekClient(db=db)
    
    print("\n2. –ö–û–ú–ü–û–ù–ï–ù–¢–´ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:")
    print(f"   ‚úÖ LLM Cache: {bool(client.cache)}")
    if client.cache:
        stats = client.cache.get_stats()
        print(f"      - TTL: 72 —á–∞—Å–∞")
        print(f"      - –ó–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ: {stats['size']}")
        print(f"      - –•–∏—Ç—ã: {stats['hits']}/{stats['total']}")
    
    print(f"   ‚úÖ Budget Guard: {bool(client.budget)}")
    if client.budget:
        daily_cost = client.budget.get_daily_cost()
        print(f"      - –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: ${client.budget.daily_limit_usd:.2f}")
        print(f"      - –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${daily_cost:.6f}")
        print(f"      - % –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: {(daily_cost / client.budget.daily_limit_usd * 100):.2f}%")
    
    # 3. –ê–Ω–∞–ª–∏–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    print("\n3. –ê–ù–ê–õ–ò–ó –°–¢–û–ò–ú–û–°–¢–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:")
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: –≤—Å–µ 50 –Ω–æ–≤–æ—Å—Ç–µ–π –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
    cost_per_call_full = 0.0000278  # ~199 —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ $0.14 –∑–∞ 1M
    cost_full_50_daily = cost_per_call_full * 50
    
    # –° –∫—ç—à–µ–º: 30% —Ö–∏—Ç —Ä–µ–π—Ç
    cost_with_cache = cost_per_call_full * 50 * 0.7  # —Ç–æ–ª—å–∫–æ 70% –ø–ª–∞—Ç—è—Ç
    
    # –° verify_category: —Ç–æ–ª—å–∫–æ 30% –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
    cost_verify = (0.000009 * 50) * 0.3  # –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ verify
    
    # –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
    total_current = cost_with_cache + cost_verify
    
    print(f"   –ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–≤—Å–µ 50 –ø–µ—Ä–µ—Å–∫–∞–∑–æ–≤): ${cost_full_50_daily:.6f}/–¥–µ–Ω—å")
    print(f"   –° –∫—ç—à–µ–º (30% —Ö–∏—Ç): ${cost_with_cache:.6f}/–¥–µ–Ω—å")
    print(f"   + verify_category (30% –Ω–æ–≤–æ—Å—Ç–µ–π): ${cost_verify:.6f}/–¥–µ–Ω—å")
    print(f"   = –ò—Ç–æ–≥–æ —Å–µ–π—á–∞—Å: ${total_current:.6f}/–¥–µ–Ω—å")
    print(f"   = –≠–∫–æ–Ω–æ–º–∏—è: {(1 - total_current / cost_full_50_daily) * 100:.1f}%")
    print(f"   = –ë—é–¥–∂–µ—Ç: {(total_current / 1.0) * 100:.3f}% –æ—Ç $1.00/–¥–µ–Ω—å")
    
    # 4. –†–µ–∑–µ—Ä–≤—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
    print("\n4. –†–ï–ó–ï–†–í–´ –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –ö–ê–ß–ï–°–¢–í–ê:")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 1: –£–≤–µ–ª–∏—á–∏—Ç—å verify_category —Å 30% –Ω–∞ 50%
    cost_variant_50pct = cost_with_cache + (0.000009 * 50) * 0.5
    print(f"\n   –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä—è—Ç—å 50% –Ω–æ–≤–æ—Å—Ç–µ–π (–≤–º–µ—Å—Ç–æ 30%)")
    print(f"      –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost_variant_50pct:.6f}/–¥–µ–Ω—å")
    print(f"      + ${(cost_variant_50pct - total_current):.6f}/–¥–µ–Ω—å (+$)")
    print(f"      –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò: +{20}% –Ω–æ–≤–æ—Å—Ç–µ–π")
    print(f"      –≠–∫–æ–Ω–æ–º–∏—è: {(1 - cost_variant_50pct / cost_full_50_daily) * 100:.1f}%")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä—è—Ç—å 100% –∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
    cost_variant_100pct = cost_with_cache + (0.000009 * 50) * 1.0
    print(f"\n   –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä—è—Ç—å 100% –Ω–æ–≤–æ—Å—Ç–µ–π")
    print(f"      –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost_variant_100pct:.6f}/–¥–µ–Ω—å")
    print(f"      + ${(cost_variant_100pct - total_current):.6f}/–¥–µ–Ω—å (+$)")
    print(f"      –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò: +{70}% –Ω–æ–≤–æ—Å—Ç–µ–π")
    print(f"      –≠–∫–æ–Ω–æ–º–∏—è: {(1 - cost_variant_100pct / cost_full_50_daily) * 100:.1f}%")
    
    # –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–∫–ª—é—á–∏—Ç—å –∫—ç—à –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
    cost_no_cache = cost_full_50_daily + (0.000009 * 50) * 1.0
    print(f"\n   –í–∞—Ä–∏–∞–Ω—Ç 3: –ë–ï–ó –∫—ç—à–∞ + 100% –ø—Ä–æ–≤–µ—Ä–∫–∞ –ò–ò (–º–∞–∫—Å–∏–º—É–º –∫–∞—á–µ—Å—Ç–≤–∞)")
    print(f"      –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost_no_cache:.6f}/–¥–µ–Ω—å")
    print(f"      –≠–∫–æ–Ω–æ–º–∏—è: {(1 - cost_no_cache / cost_full_50_daily) * 100:.1f}%")
    print(f"      ‚ö†Ô∏è  –≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç")
    
    # 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ 66% —ç–∫–æ–Ω–æ–º–∏–∏
    print("\n5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø –î–õ–Ø 66% –≠–ö–û–ù–û–ú–ò–ò (–£–õ–£–ß–®–ï–ù–ù–û–ï –ö–ê–ß–ï–°–¢–í–û):")
    cost_target_66pct = cost_full_50_daily * (1 - 0.66)  # 34% –æ—Ç –ø–æ–ª–Ω–æ–π —Ü–µ–Ω—ã
    print(f"   –¶–µ–ª–µ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${cost_target_66pct:.6f}/–¥–µ–Ω—å")
    print(f"   –°–µ–π—á–∞—Å –¥–æ—Å—Ç–∏–≥–∞–µ–º: ${total_current:.6f}/–¥–µ–Ω—å (94.7% —ç–∫–æ–Ω–æ–º–∏—è)")
    print(f"   ‚úÖ –î–û–°–¢–ê–¢–û–ß–ù–û –†–ï–ó–ï–†–í–û–í! –ú–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ")
    print(f"\n   –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –¥–ª—è 66% —ç–∫–æ–Ω–æ–º–∏–∏:")
    print(f"   ‚Ä¢ AI_CATEGORY_VERIFICATION_RATE = 0.8 (–≤–º–µ—Å—Ç–æ 0.3)")
    print(f"   ‚Ä¢ –û—Å—Ç–∞–≤–∏—Ç—å –∫—ç—à –≤–∫–ª—é—á–µ–Ω–Ω—ã–º (TTL 72 —á–∞—Å–∞)")
    print(f"   ‚Ä¢ –û—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π 13-–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç")
    print(f"   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~${cost_variant_50pct:.6f}-${cost_variant_100pct:.6f}/–¥–µ–Ω—å")
    print(f"   ‚Ä¢ –≠–∫–æ–Ω–æ–º–∏—è: ~77-79%")
    
    # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ 13 –ø—É–Ω–∫—Ç–æ–≤ –ø—Ä–æ–º–ø—Ç–∞
    print("\n6. –ü–†–û–í–ï–†–ö–ê 13 –ü–£–ù–ö–¢–û–í –ü–†–û–ú–ü–¢–ê –í –ö–û–î–ï:")
    from net.deepseek_client import _build_messages
    messages = _build_messages("Test", "Test")
    system_msg = messages[0]['content']
    
    rules_check = [
        ("7 —Å–ª–æ–≤", "7 —Å–ª–æ–≤" in system_msg),
        ("–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑", "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑" in system_msg),
        ("–Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–¥—É–º—ã", "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–¥—É–º—ã" in system_msg),
        ("—É–¥–∞–ª–∏ –ø–æ–≤—Ç–æ—Ä—ã", "—É–¥–∞–ª–∏ –ø–æ–≤—Ç–æ—Ä—ã" in system_msg),
        ("100-150 —Å–ª–æ–≤", "100‚Äì150" in system_msg),
        ("12 —Å–ª–æ–≤", "12 —Å–ª–æ–≤" in system_msg),
        ("–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å—Å—è –≤—Å–ª—É—Ö", "–ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å—Å—è –≤—Å–ª—É—Ö" in system_msg),
        ("–¥–µ–µ–ø—Ä–∏—á–∞—Å—Ç–∏—è", "–¥–µ–µ–ø—Ä–∏—á–∞—Å—Ç–∏—è" in system_msg),
        ("–∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º—ã", "–∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º—ã" in system_msg),
        ("—Å—É—Ö–æ–π", "—Å—É—Ö–æ–π" in system_msg),
        ("–æ—Ü–µ–Ω–∫—É", "–æ—Ü–µ–Ω–∫—É" in system_msg),
        ("–ø—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã", "–ø—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã" in system_msg or "—Ü–∏—Ç–∞—Ç—ã" in system_msg),
        ("–∏—Å—Ç–æ—á–Ω–∏–∫", "–∏—Å—Ç–æ—á–Ω–∏–∫" in system_msg),
    ]
    
    for rule_name, found in rules_check:
        status = "‚úÖ" if found else "‚ùå"
        print(f"   {status} –ü—Ä–∞–≤–∏–ª–æ: {rule_name}")
    
    all_rules = all(found for _, found in rules_check)
    print(f"\n   {'‚úÖ' if all_rules else '‚ùå'} –í–°–ï 13 –ü–†–ê–í–ò–õ –ü–†–ò–°–£–¢–°–¢–í–£–Æ–¢: {all_rules}")
    
    print("\n" + "=" * 60)
    print("–ò–¢–û–ì–û–í–´–ô –í–´–í–û–î:")
    print("=" * 60)
    print("""
‚úÖ –ö–ê–ß–ï–°–¢–í–û: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï
   - –í—Å–µ 13 –ø—Ä–∞–≤–∏–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø—Ä–æ–º–ø—Ç–µ
   - AI –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
   - –ö—ç—à –≤–∫–ª—é—á–µ–Ω (—ç–∫–æ–Ω–æ–º–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞)
   
‚úÖ –ë–Æ–î–ñ–ï–¢: –ü–†–ï–í–´–®–ï–ù–´ –†–ï–ó–ï–†–í–´
   - –¢–µ–∫—É—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è: 94.7%
   - –¶–µ–ª–µ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è: 66%
   - –°–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π: 28.7%!
   
‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:
   –£–≤–µ–ª–∏—á–∏—Ç—å AI_CATEGORY_VERIFICATION_RATE —Å 30% –¥–æ 80%
   –≠—Ç–æ —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ö–µ—à—Ç–µ–≥–æ–≤ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º
   —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–≤—Å–µ —Ä–∞–≤–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö 66% —ç–∫–æ–Ω–æ–º–∏–∏)
   
üöÄ –°–¢–ê–¢–£–°: –ì–û–¢–û–í–û –ö PRODUCTION
   –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–æ/—Å—Ç–æ–∏–º–æ—Å—Ç—å
    """)

if __name__ == '__main__':
    asyncio.run(test_quality_reserves())
